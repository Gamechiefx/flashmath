# ==============================================================================
# FlashMath Production Docker Compose
# ==============================================================================
#
# IMPORTANT: Database Persistence
# - SQLite database is stored in ./data/flashmath.db (bind mount)
# - This ensures data persists even if containers/volumes are deleted
#
# Before running:
# 1. Copy .env.example to .env and fill in production values
# 2. Ensure ./data directory exists with proper permissions
# 3. Configure your reverse proxy (nginx/traefik) to point to port 3000
#
# Usage:
#   docker-compose up -d
#   docker-compose logs -f flashmath
#   docker-compose down  # Safe - keeps data
#
# ==============================================================================

services:
  flashmath:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: flashmath
    ports:
      - "3000:3000"
    volumes:
      # CRITICAL: Use bind mount for database persistence
      - ./data:/app/data
    environment:
      - NODE_ENV=production
      # ============================================
      # AUTH CONFIGURATION
      # ============================================
      - NEXTAUTH_URL=https://flashmath.io
      - AUTH_SECRET=${AUTH_SECRET}
      
      # ============================================
      # DATABASE CONFIGURATION
      # ============================================
      - DATABASE_PATH=/app/data/flashmath.db
      
      # ============================================
      # EMAIL CONFIGURATION (SMTP)
      # ============================================
      - SMTP_HOST=${SMTP_HOST:-mail.lanit.services}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USER=${SMTP_USER:-auth-mailer@flashmath.io}
      - SMTP_PASS=${SMTP_PASS}
      - SMTP_SECURE=${SMTP_SECURE:-false}
      - EMAIL_FROM=${EMAIL_FROM:-Flash Math <noreply@flashmath.io>}
      - EMAIL_REPLY_TO=${EMAIL_REPLY_TO:-support@flashmath.io}
      
      # ============================================
      # REDIS (Optional - for Arena matchmaking)
      # ============================================
      # Uncomment if using Redis:
      # - REDIS_URL=${REDIS_URL}
      
      # Dev Tools - DISABLED in production
    restart: always
    healthcheck:
      # Use node to check health - more reliable than wget
      test: ["CMD", "node", "-e", "require('http').get('http://127.0.0.1:3000/api/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

# ==============================================================================
# NO NAMED VOLUMES FOR SQLITE
# ==============================================================================
# SQLite uses a bind mount (./data) to prevent data loss
# Only add volumes here if using PostgreSQL/Redis in production
