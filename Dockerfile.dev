# Development Dockerfile for FlashMath
FROM node:20-alpine

# Install dependencies for native modules (better-sqlite3) and sqlite3 CLI
# Also install netcat for health checks in entrypoint
RUN apk add --no-cache libc6-compat python3 make g++ sqlite netcat-openbsd

WORKDIR /app

# Copy package files
COPY package.json package-lock.json* ./

# Install dependencies
RUN npm ci

# Copy the rest of the application
COPY . .

# Make entrypoint executable
RUN chmod +x scripts/docker-entrypoint.sh 2>/dev/null || true

# Expose port
EXPOSE 3000

ENV PORT=3000
ENV HOSTNAME="0.0.0.0"

# Run migrations before starting the server
# --skip-if-exists ensures safe deployment even on existing databases
CMD ["sh", "-c", "node scripts/migrate.js --skip-if-exists && npm run dev:server"]
