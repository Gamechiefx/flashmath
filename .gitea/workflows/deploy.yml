name: Deploy FlashMath to Prod

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Clean workspace
        run: |
          # Remove any leftover files from previous runs
          rm -rf $GITHUB_WORKSPACE/* || true
          rm -rf $GITHUB_WORKSPACE/.* || true

      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          clean: true

      - name: Ensure data volume has correct permissions
        run: |
          # Create a temporary container to fix permissions on the named volume
          # This is needed because the nextjs user (1001) needs write access
          docker volume create flashmath_data 2>/dev/null || true
          docker run --rm -v flashmath_data:/data alpine chown -R 1001:1001 /data

      - name: Build and Start Container
        env:
          AUTH_SECRET: ${{ secrets.AUTH_SECRET }}
        run: |
          # Stop and remove existing container
          docker compose down || true
          
          # Build fresh image with new code
          docker compose build --no-cache
          
          # Start container
          docker compose up -d
          
          # Cleanup old images
          docker image prune -f
